---

# Ugly hack to get the interfacescripts of all the available interfaces
- name: get interfaces
  shell: "ls /sys/class/net/ | grep -v 'lo'"
  register: interfaces
  changed_when: false

- name: get interface scripts
  shell: "ls /etc/sysconfig/network-scripts/* | egrep '{% for if in interfaces.stdout_lines %}ifcfg-{{ if }}$|{% endfor %}^$'"
  register: interfacescripts
  changed_when: false

- name: enable DHCPv6 on public interfaces
  lineinfile:
    dest: "{{ item }}"
    insertafter: "^IPV6INIT="
    regexp: "^DHCPV6C=.*"
    line: 'DHCPV6C="yes"'
    backup: yes
  notify: restart network
  with_items: "{{ interfacescripts.stdout_lines }}" 

- name: "disable network manager in {{ item }}"
  lineinfile:
    dest: "{{ item }}"
    regexp: "^NM_CONTROLLED=.*"
    line: "NM_CONTROLLED=no"
    backup: yes
  notify: restart network
  with_items: "{{ interfacescripts.stdout_lines }}" 
